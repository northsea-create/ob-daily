
# 神通数据库 SQL 日期与时间操作及函数详解

本文档详细介绍了神通数据库中与日期和时间相关的数据类型、操作符以及各类函数的用法。

## 1. 日期/时间相关数据类型

神通数据库支持以下几种与时间相关的数据类型，它们代表了不同的时间粒度：

*   **`DATE`**: 表示日期，例如 `date '2020-10-1'`。
*   **`TIME`**: 表示时间，例如 `time '9:8:7 AM'` 或 `time '9:8:7'`。
*   **`TIMESTAMP`**: 表示日期和时间的组合。例如 `timestamp '2020-10-1 9:8:7 AM'` 或 `timestamp '2020-10-1 9:8:7'`。`SYSDATE` 函数返回的就是系统当前的 `TIMESTAMP` 类型。
*   **`INTERVAL`**: 表示一个时间间隔或持续时间，可以精确到年/月 (`INTERVAL YEAR TO MONTH`) 或 日/秒 (`INTERVAL DAY TO SECOND`)。
    *   **示例**:
        ```sql
        interval '1' year
        interval '1-1' year to month
        interval '1 2:3:4.123456' day to second
        ```
简单来说，从用法上看，`DATE` 关注年、月、日，`TIME` 关注时、分、秒等时间部分，而 `TIMESTAMP` 则包含完整的日期和时间信息。`INTERVAL` 则用于表示两个时间点之间的跨度。


### `INTERVAL` 隐式单位常见格式示例：

1.  **`'Y-M'` (默认年-月)**
    ```sql
    SELECT INTERVAL '1-6';
    -- 结果: 1 year 6 months
    ```

2.  **`'D HH:MI:SS'` (天 小时:分钟:秒)**
    ```sql
    SELECT INTERVAL '3 10:20:30';
    -- 结果: 3 days 10 hours 20 minutes 30 seconds
    ```

3.  **`'HH:MI:SS'` (小时:分钟:秒)**
    ```sql
    SELECT INTERVAL '01:02:03';
    -- 结果: 1 hour 2 minutes 3 seconds
    ```

4.  **`'HH:MI'` (默认小时:分钟)**
    ```sql
    SELECT INTERVAL '04:05';
    -- 结果: 4 hours 5 minutes
    ```


## 2. 日期/时间/时间戳/时间间隔操作符

文档中介绍了三个主要的操作符用于处理这些类型：

### 2.1. `+` 操作符

*   可以在日期/时间/时间戳类型数据的基础上加上一个数值型数据（表示天数）或者一个时间间隔类型数据，得到一个新的日期/时间/时间戳类型数据。
    *   **示例**:
        ```sql
        SELECT date '2020-10-1' + 1;
        SELECT date '2020-10-1' + interval '1' year;
        ```
*   也可以把日期和时间类型数据组合成一个新的时间戳类型数据。
    *   **示例**:
        ```sql
        SELECT date '2020-10-1' + time '9:8:7';
        ```

### 2.2. `-` 操作符

*   可以在日期/时间戳类型数据基础上减去一个数值（表示天数）或者时间间隔，得到一个新的日期/时间间隔类型数据。
    *   **示例**:
        ```sql
        SELECT date '2020-10-1' - 1;
        SELECT timestamp '2020-10-1 9:8:7' - interval '1' month;
        ```
*   可以计算出两个日期/时间/时间戳类型数据之间的间隔。
    *   **示例**:
        ```sql
        SELECT date '2020-10-1' - date '2019-10-1';
        SELECT time '9:8:7' - '19:8:1';
        SELECT timestamp '2020-10-1 9:8:7' - timestamp '2020-10-3 9:0:7';
        ```

### 2.3. `OVERLAPS` 操作符

*   用于判断左右两个时间段之间是否有重叠。如果重叠，返回 `TRUE`，否则返回 `FALSE`。
*   操作符两侧的操作数分别表示一个时间段。时间段的起点是第一个时间，终点是第二个时间。
*   如果操作数中包含 `INTERVAL YEAR TO MONTH` 或 `INTERVAL DAY TO SECOND` 类型，则时间段的起点是第一个时间，终点是第一个时间加上其后的 `Interval` 值。
    *   **示例**:
        ```sql
        SELECT (date '2003-10-1', date '2013-10-1') OVERLAPS (date '2008-8-8', date '2020-10-1');
        SELECT (date '2008-8-8', interval '10-1' year to month) OVERLAPS (date '2020-10-1', date '2022-2-4');
        ```

## 3. 日期和时间函数

文档详细列举并说明了以下日期和时间函数：

### 3.1. `SYSDATE`

*   **说明**: 返回系统当前时间。
*   **示例**:
    ```sql
    SELECT SYSDATE;
    ```

### 3.2. `ADD_MONTHS`

*   **说明**: 返回给定日期之前或之后几个月的时间。
*   **语法**:
    ```sql
    ADD_MONTHS(date_expr, num_expr)
    ```
*   **示例**:
    ```sql
    SELECT ADD_MONTHS('2020-10-1', -2);
    ```

### 3.3. `MONTHS_BETWEEN`

*   **说明**: 返回给定的两个日期之间的月份差。
*   **语法**:
    ```sql
    MONTHS_BETWEEN(date_expr1, date_expr2)
    ```
*   **示例**:
    ```sql
    SELECT MONTHS_BETWEEN('2008-8-8 20:00:00 ', '2022-2-4 20:00:00');
    ```

### 3.4. `DATE_TRUNC`

*   **说明**: 给定一个日期，截断成指定的精度（field），如年、月、日等。该函数也支持对 `INTERVAL` 类型进行截断。
*   **语法**:
    ```sql
    DATE_TRUNC(field, date_expr)
    ```
*   **示例**:
    ```sql
    SELECT DATE_TRUNC('month', date '2022-2-4');
    SELECT DATE_TRUNC('day', timestamp '2022-2-4 7:8:9');
    ```

### 3.5. `DATENAME`

*   **说明**: 给定一个日期，返回指定的域（field）的整数值。
*   **语法**:
    ```sql
    DATENAME(field, date_expr)
    ```
*   **示例**:
    ```sql
    SELECT DATENAME('month', date '2022-2-4');
    ```

### 3.6. `DATEADD`

*   **说明**: 返回指定日期加上一个时间间隔后的新日期值，`field` 指明了需要加到哪个域上。
*   **语法**:
    ```sql
    DATEADD(field, date_expr, num_expr)
    -- 或
    DATEADD(field, num_expr, date_expr)
    ```
    *注意参数顺序可以调换。*
*   **示例**:
    ```sql
    SELECT DATEADD('day', 2, timestamp '2022-2-4 7:8:9');
    ```

### 3.7. `DATEDIFF`

*   **说明**: 计算两个日期之间的间隔，由 `field` 指定间隔单位（如年、月、日、秒等）。
*   **语法**:
    ```sql
    DATEDIFF(field, date_expr1, date_expr2)
    ```
*   **示例**:
    ```sql
    SELECT DATEDIFF('year', '2022-12-31', '2023-1-1');
    SELECT DATEDIFF('second', '2022-12-31 23:59:59', '2023-1-1 00:00:01');
    ```

### 3.8. `YEAR`, `MONTH`, `HOUR`, `MINUTE`, `SECOND`

*   **说明**: 分别返回指定日期/时间中的年、月、时、分、秒域。
*   **返回值**: 都是 `INT` 类型。
*   **示例**:
    ```sql
    SELECT YEAR(SYSDATE), MONTH(SYSDATE);
    ```

### 3.9. `DAYOFWEEK`, `DAYOFMONTH`, `DAYOFYEAR`

*   **说明**: 分别返回指定日期为一周中的第几天、一个月中的第几天、一年中的第几天。
*   **返回值**: 都是 `INT` 类型。
*   **注意点**: `DAYOFWEEK` 返回 1 到 7 之间的一个整数，1 代表星期日，2 代表星期一，依此类推。
*   **示例**:
    ```sql
    SELECT DAYOFWEEK(SYSDATE);
    ```

## 4. 其他常用函数

神通数据库支持的函数主要包括以下几类：

### 4.1. 数学函数

*   **`ABS`**: 返回给定数字表达式的绝对值。
*   **`CEIL`** (和 `CEILING`): 返回大于或等于给定数字表达式的最小整数（取顶函数）。
*   **`FLOOR`**: 返回小于或等于给定数字表达式的最大整数（取底函数）。对于 `interval day to second` 类型，返回值为整数天。
*   **`MOD`**: 求余数（模）。
*   **`POWER`**: 返回给定表达式乘指定次方的值。
*   **`ROUND`**: 返回数字表达式并四舍五入为指定的长度或精度。可以指定小数点后的位数，也可以指定为负数（例如 -2 表示四舍五入到百位）。
*   **`TRUNC`**: 截断为指定小数位置的数字。也可以按指定的日期格式截断日期值（详见日期相关函数中的 `DATE_TRUNC` 或本节末的类型转换）。

### 4.2. 字符函数

*   **`CHARINDEX`**: 返回字符或者字符串在另一个字符串中的起始位置。可以指定开始查找的位置。
*   **`CONCAT`**: 字符串连接函数，将多个字符串连接成一个新的字符串。
*   **`LEFT`**: 返回从字符串左边开始指定字符个数的子串。
*   **`RIGHT`**: 返回从字符串右边开始指定字符个数的子串，语法与 `LEFT` 相同。
*   **`LENGTH`**: 返回字符串长度（字符数）。
*   **`LTRIM`**: 字符串左截断函数。
    *   **特点/注意点**: 如果指定第二个参数 (`char_expr2`)，它会删除第一个字符串 (`char_expr1`) 左边出现的 `char_expr2` 中任意字符，而不是按整个 `char_expr2` 字符串进行匹配删除。如果不指定第二个参数，默认删除起始空格。
*   **`RTRIM`**: 字符串右截断函数。
    *   **特点/注意点**: 与 `LTRIM` 类似，如果指定第二个参数，删除的是右边出现的 `char_expr2` 中任意字符。如果不指定第二个参数，默认删除尾随空格。
*   **`REPLACE`**: 用一个字符串替换另一个字符串的指定子串。可以将子串替换为空字符串。
*   **`SUBSTR`**: 返回字符表达式从指定位置开始、指定长度的字符。起始位置可以指定为负数。

### 4.3. 聚集函数

*   **`AVG`**: 计算一组值的平均值。
*   **`SUM`**: 返回表达式中所有值的和。
*   **`MAX`**: 返回表达式中的最大值。
*   **`MIN`**: 返回表达式中的最小值。
    *   **特点/注意点**: `AVG`, `SUM`, `MAX`, `MIN` 在计算时都会忽略空值。
    *   **语法**: 通常支持 `ALL` (默认) 和 `DISTINCT` 参数。`ALL` 对所有值进行计算，`DISTINCT` 只对唯一值进行计算。
    *   `num_expr` 参数必须是数值类型（对 `AVG`, `SUM`）或任何类型（对 `MAX`, `MIN`）的表达式，不允许使用聚合函数或子查询。
*   **`COUNT`**: 计算输入参数中元素的个数，常用于计算行数。
    *   **`COUNT(*)`**: 返回表或组中的所有行的数量，包括含有空值的行，不需要表达式参数。
    *   **`COUNT([ALL|DISTINCT] expr)`**: 计算表达式非空值的数量。`ALL` 对组中每一行计算表达式的值，返回非空值的数量（默认）。`DISTINCT` 返回组中表达式唯一非空值的数量。`expr` 不允许使用聚合函数或子查询。

### 4.4. 其他通用函数

#### 4.4.1. 类型转换函数

*   **`TO_CHAR`**: 转换成 `CHAR` 类型。可用于数值型和 `TIMESTAMP`/`DATE` 类型，通过格式表达式指定输出格式。
*   **`TO_DATE`**: 将文本型数据转换成 `DATE` 类型。输入的文本必须是 `TIMESTAMP` 类型的格式（间隔符可变），格式表达式可选。
*   **`TO_NUMBER`**: 将整型或者文本数据转换成 `NUMERIC` 类型。输入的文本可以包含数字、符号。需要格式表达式来指定转换格式。
*   **`TO_TIMESTAMP`**: 将文本类型数据转换成 `TIMESTAMP` 类型。输入的文本必须是 `TIMESTAMP` 数据类型的格式（间隔符可变），格式表达式可选，不指定时参考 `TIMESTAMPFORMAT` 参数格式。
*   **`CAST`**: 通用类型转换函数。语法为 `CAST(expr AS data_type)`。

#### 4.4.2. `ISNULL`

*   **特点/注意点**:
    *   一个参数时 (`ISNULL(expr1)`)：如果参数值为空，返回真；否则返回假。
    *   两个参数时 (`ISNULL(expr1, expr2)`)：如果第一个参数 (`expr1`) 不为空，返回第一个参数值；否则返回第二个参数值 (`expr2`)。若两个参数都为空，则返回空。

#### 4.4.3. `DECODE`

*   **说明**: 相当于一个条件语句 (`IF`)。它将输入值 (`expr`) 与参数列表中的搜索值 (`serach_expr`) 依次比较。如果匹配成功，返回对应的结果值 (`result_expr`)。如果未能与任何搜索值匹配成功，则返回默认值 (`default`)。

#### 4.4.4. 窗口函数 (排序编号函数)

*   包括 `ROW_NUMBER`, `RANK`, `DENSE_RANK`。
*   与 `OVER` 子句一起使用。`OVER` 子句可以包含 `PARTITION BY expr1` (将记录分成多个区，默认所有记录为一个区) 和 `ORDER BY expr2` (确定分区内行的排序顺序)。

*   **`ROW_NUMBER`**: 针对 `SELECT` 语句返回的每一行，从 1 开始分配连续的编号。
    *   **特点/注意点**: 排序时，不考虑并列（ties）的情况，排序编号不会重复，总数不变。

*   **`RANK`**:
    *   **特点/注意点**: 排序时，考虑并列的情况，排序编号会重复，但会跳过（skip）重复的序号（例如，如果两个人并列第一，那么下一个序号是第三）。总数不变。

*   **`DENSE_RANK`**:
    *   **特点/注意点**: 排序时，考虑并列的情况，排序编号会重复，但不会跳过（skip）重复的序号（例如，如果两个人并列第一，那么下一个序号是第二）。总数会减少（当排序编号有重复时）。

---